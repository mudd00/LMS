# VerseUp! ë©”íƒ€ë²„ìŠ¤ êµìœ¡ ê¸°ëŠ¥ ìƒì„¸ ë¬¸ì„œ

ì´ ë¬¸ì„œëŠ” VerseUp í”„ë¡œì íŠ¸ì˜ êµìœ¡ ê´€ë ¨ ê¸°ëŠ¥ë“¤ì„ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì— ì´ì‹í•  ë•Œ ì°¸ê³ í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

---

## ëª©ì°¨

### Part 1: êµìœ¡ ê¸°ëŠ¥
1. [ê°•ì‚¬ í™”ë©´ ê³µìœ  ê¸°ëŠ¥](#1-ê°•ì‚¬-í™”ë©´-ê³µìœ -ê¸°ëŠ¥)
2. [í•™ìƒ í™”ë©´ ê³µìœ  ë³´ê¸° ê¸°ëŠ¥](#2-í•™ìƒ-í™”ë©´-ê³µìœ -ë³´ê¸°-ê¸°ëŠ¥)
3. [í•™ìƒ í™”ë©´ ìº¡ì²˜/ê³µìœ  (í•™ë¶€ëª¨ìš©)](#3-í•™ìƒ-í™”ë©´-ìº¡ì²˜ê³µìœ -í•™ë¶€ëª¨ìš©)
4. [íŒì„œ ê¸°ëŠ¥ (ì¹ íŒ)](#4-íŒì„œ-ê¸°ëŠ¥-ì¹ íŒ)
5. [ìŒì„± ì±„íŒ… (ë§ˆì´í¬)](#5-ìŒì„±-ì±„íŒ…-ë§ˆì´í¬)
6. [í…ìŠ¤íŠ¸ ì±„íŒ…](#6-í…ìŠ¤íŠ¸-ì±„íŒ…)
7. [CCTV ê¸°ëŠ¥](#7-cctv-ê¸°ëŠ¥)

### Part 2: ë©”íƒ€ë²„ìŠ¤ ê¸°ëŠ¥
8. [ì˜ì/êµíƒ ìƒí˜¸ì‘ìš©](#8-ì˜ìêµíƒ-ìƒí˜¸ì‘ìš©)
9. [í¬íƒˆ ì‹œìŠ¤í…œ (ë§µ ì´ë™)](#9-í¬íƒˆ-ì‹œìŠ¤í…œ-ë§µ-ì´ë™)
10. [ë¬¸ ì‹œìŠ¤í…œ (ê°•ì˜ì‹¤ ì…ì¥)](#10-ë¬¸-ì‹œìŠ¤í…œ-ê°•ì˜ì‹¤-ì…ì¥)
11. [ë©€í‹°í”Œë ˆì´ì–´ ë™ê¸°í™”](#11-ë©€í‹°í”Œë ˆì´ì–´-ë™ê¸°í™”)
12. [ìºë¦­í„° ëª¨ë¸ ë° ì• ë‹ˆë©”ì´ì…˜](#12-ìºë¦­í„°-ëª¨ë¸-ë°-ì• ë‹ˆë©”ì´ì…˜)
13. [ì¹´ë©”ë¼ ì‹œìŠ¤í…œ](#13-ì¹´ë©”ë¼-ì‹œìŠ¤í…œ)
14. [í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤](#14-í‚¤ë³´ë“œ-ì»¨íŠ¸ë¡¤)
15. [í”Œë ˆì´ì–´ ë¬¼ë¦¬ ë° ì´ë™](#15-í”Œë ˆì´ì–´-ë¬¼ë¦¬-ë°-ì´ë™)

### Part 3: íŠ¹ìˆ˜ ê¸°ëŠ¥
16. [í•™ë¶€ëª¨ ì°¸ê´€ ëª¨ë“œ](#16-í•™ë¶€ëª¨-ì°¸ê´€-ëª¨ë“œ)
17. [ê°•ì˜ì‹¤ ì ‘ê·¼ ê¶Œí•œ ì‹œìŠ¤í…œ](#17-ê°•ì˜ì‹¤-ì ‘ê·¼-ê¶Œí•œ-ì‹œìŠ¤í…œ)

### Part 4: ê°œë°œ ê°€ì´ë“œ
18. [í™˜ê²½ ë³€ìˆ˜ ì„¤ì •](#18-í™˜ê²½-ë³€ìˆ˜-ì„¤ì •)
19. [WebRTC ì„¤ì •](#19-webrtc-ì„¤ì •)
20. [ì†Œì¼“ ì´ë²¤íŠ¸ ì „ì²´ ëª©ë¡](#20-ì†Œì¼“-ì´ë²¤íŠ¸-ì „ì²´-ëª©ë¡)
21. [í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹…](#21-í…ŒìŠ¤íŠ¸-ë°-ë””ë²„ê¹…)
22. [ì´ì‹ ì‹œ ì£¼ì˜ì‚¬í•­](#22-ì´ì‹-ì‹œ-ì£¼ì˜ì‚¬í•­)

---

# Part 1: êµìœ¡ ê¸°ëŠ¥

---

## 1. ê°•ì‚¬ í™”ë©´ ê³µìœ  ê¸°ëŠ¥

ê°•ì‚¬ê°€ êµíƒì— ì„œì„œ ìì‹ ì˜ í™”ë©´ì„ í•™ìƒë“¤ì—ê²Œ ê³µìœ í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/hooks/useScreenShare.js` | í™”ë©´ ê³µìœ  ì‹œì‘/ì¤‘ì§€ ë¡œì§ (WebRTC) |
| `src/components/metaverse/Screen.jsx` | 3D ì”¬ ë‚´ í™”ë©´ í‘œì‹œ (VideoTexture) |
| `server/sockets/index.js` | ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (screenshare:*) |

### ë™ì‘ íë¦„

```
[ê°•ì‚¬]                          [ì„œë²„]                          [í•™ìƒë“¤]
   â”‚                              â”‚                               â”‚
   â”‚ screenshare:start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                               â”‚
   â”‚                              â”‚ screenshare:started â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                              â”‚                               â”‚
   â”‚ (WebRTC Offer) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                              â”‚                               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (WebRTC Answer)â”‚
   â”‚                              â”‚                               â”‚
   â”‚ ICE Candidate êµí™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                              â”‚                               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í™”ë©´ ìŠ¤íŠ¸ë¦¼ ì „ì†¡ (P2P) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

### useScreenShare í›…

**íŒŒì¼**: `src/hooks/useScreenShare.js`

```javascript
import { useScreenShare } from '../hooks/useScreenShare'

// roomId: ë°© ID, students: í•™ìƒ ëª©ë¡, enabled: ê°•ì‚¬ì¸ì§€ ì—¬ë¶€
const screenShare = useScreenShare(roomId, students, isInstructor)
```

**ë°˜í™˜ê°’:**

| ì†ì„±/ë©”ì„œë“œ | íƒ€ì… | ì„¤ëª… |
|------------|------|------|
| `isSharing` | boolean | í˜„ì¬ í™”ë©´ ê³µìœ  ì¤‘ì¸ì§€ |
| `error` | string \| null | ì—ëŸ¬ ë©”ì‹œì§€ |
| `startSharing()` | function | í™”ë©´ ê³µìœ  ì‹œì‘ (getDisplayMedia í˜¸ì¶œ) |
| `stopSharing()` | function | í™”ë©´ ê³µìœ  ì¤‘ì§€ |

**ë‚´ë¶€ ë™ì‘:**
1. `getDisplayMedia`ë¡œ í™”ë©´+ì‹œìŠ¤í…œ ì˜¤ë””ì˜¤ ìº¡ì²˜
2. ì„œë²„ì— `screenshare:start` ì´ë²¤íŠ¸ ì „ì†¡
3. ê° í•™ìƒì—ê²Œ WebRTC Offer ì „ì†¡
4. Answer ìˆ˜ì‹  í›„ P2P ìŠ¤íŠ¸ë¦¼ ì „ì†¡

**í•µì‹¬ ì½”ë“œ (í™”ë©´ ìº¡ì²˜):**
```javascript
const stream = await navigator.mediaDevices.getDisplayMedia({
  video: {
    width: { ideal: 1920 },
    height: { ideal: 1080 },
    frameRate: { ideal: 30 },
  },
  audio: true, // ì‹œìŠ¤í…œ ì˜¤ë””ì˜¤ ìº¡ì²˜
})

// ì‚¬ìš©ìê°€ ë¸Œë¼ìš°ì € UIë¡œ ê³µìœ  ì¤‘ì§€ ì‹œ ê°ì§€
stream.getVideoTracks()[0].onended = () => {
  stopSharing()
}
```

### ì†Œì¼“ ì´ë²¤íŠ¸

| ì´ë²¤íŠ¸ | ë°©í–¥ | ë°ì´í„° | ì„¤ëª… |
|--------|------|--------|------|
| `screenshare:start` | Client â†’ Server | `{ roomId }` | í™”ë©´ ê³µìœ  ì‹œì‘ ì•Œë¦¼ |
| `screenshare:started` | Server â†’ Room | `{ teacherId, teacherSocketId, teacherName }` | ê°•ì‚¬ ì •ë³´ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `screenshare:stop` | Client â†’ Server | `{ roomId }` | í™”ë©´ ê³µìœ  ì¢…ë£Œ ì•Œë¦¼ |
| `screenshare:stopped` | Server â†’ Room | `{}` | ì¢…ë£Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `screenshare:offer` | Client â†’ Client | `{ targetSocketId, offer }` | WebRTC Offer |
| `screenshare:answer` | Client â†’ Client | `{ targetSocketId, answer }` | WebRTC Answer |
| `screenshare:ice-candidate` | Client â†’ Client | `{ targetSocketId, candidate }` | ICE Candidate |

### 3D í™”ë©´ í‘œì‹œ (Screen.jsx)

**íŒŒì¼**: `src/components/metaverse/Screen.jsx`

```jsx
import Screen from './Screen.jsx'

<Screen
  position={[0, 5, -10]}  // 3D ê³µê°„ ìœ„ì¹˜
  size={[8, 4.5]}         // í™”ë©´ í¬ê¸° (ê°€ë¡œ, ì„¸ë¡œ)
  videoStream={stream}    // MediaStream ê°ì²´
/>
```

**í•µì‹¬ ì½”ë“œ:**
```javascript
// ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
const video = document.createElement('video')
video.srcObject = videoStream
video.muted = true  // ìŒì†Œê±° (ì˜¤ë””ì˜¤ëŠ” ë³„ë„ ì²˜ë¦¬)
video.play()

// ë¹„ë””ì˜¤ í…ìŠ¤ì²˜ ìƒì„±
const texture = new THREE.VideoTexture(video)
texture.minFilter = THREE.LinearFilter
texture.magFilter = THREE.LinearFilter

// 3D í‰ë©´ì— ì ìš©
<mesh>
  <planeGeometry args={[size[0], size[1]]} />
  <meshBasicMaterial map={texture} side={THREE.DoubleSide} />
</mesh>
```

**ê°œë°œ ì‹œ ê²ªì€ ë¬¸ì œ:**
- ë¹„ë””ì˜¤ ìë™ì¬ìƒ ì‹¤íŒ¨ â†’ `muted` ì†ì„± í•„ìˆ˜
- í…ìŠ¤ì²˜ ì—…ë°ì´íŠ¸ ì•ˆ ë¨ â†’ `VideoTexture` ì‚¬ìš© (ìë™ ì—…ë°ì´íŠ¸)
- í™”ë©´ ë¹„ìœ¨ ê¹¨ì§ â†’ `preserveAspectRatio` ë¡œì§ ì¶”ê°€ í•„ìš”

---

## 2. í•™ìƒ í™”ë©´ ê³µìœ  ë³´ê¸° ê¸°ëŠ¥

í•™ìƒì´ ê°•ì‚¬ì˜ ê³µìœ  í™”ë©´ì„ ì˜¤ë²„ë ˆì´ë¡œ ì‹œì²­í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/hooks/useScreenReceive.js` | í™”ë©´ ê³µìœ  ìˆ˜ì‹  (WebRTC) |
| `src/components/metaverse/ScreenShareOverlay.jsx` | ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê°€ëŠ¥í•œ ì˜¤ë²„ë ˆì´ UI |

### useScreenReceive í›…

**íŒŒì¼**: `src/hooks/useScreenReceive.js`

```javascript
import { useScreenReceive } from '../hooks/useScreenReceive'

const screenReceive = useScreenReceive(roomId, !isInstructor)
```

**ë°˜í™˜ê°’:**

| ì†ì„± | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `teacherInfo` | object \| null | `{ teacherId, teacherSocketId, teacherName }` |
| `teacherStream` | MediaStream \| null | ê°•ì‚¬ í™”ë©´ ìŠ¤íŠ¸ë¦¼ |
| `isReceiving` | boolean | ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ì¤‘ì¸ì§€ |

**ë‚´ë¶€ ë™ì‘:**
1. `screenshare:started` ìˆ˜ì‹  â†’ `teacherInfo` ì €ì¥
2. `screenshare:offer` ìˆ˜ì‹  â†’ PeerConnection ìƒì„±, Answer ì „ì†¡
3. `ontrack` ì´ë²¤íŠ¸ â†’ `teacherStream` ì €ì¥

### ScreenShareOverlay ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/ScreenShareOverlay.jsx`

í•™ìƒì´ "í™”ë©´ ë³´ê¸°" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í‘œì‹œë˜ëŠ” ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê°€ëŠ¥í•œ ì˜¤ë²„ë ˆì´ì…ë‹ˆë‹¤.

```jsx
<ScreenShareOverlay
  stream={screenReceive.teacherStream}
  teacherName={screenReceive.teacherInfo?.teacherName}
  onClose={() => setIsViewingScreen(false)}
/>
```

**ì£¼ìš” ê¸°ëŠ¥:**
- ë“œë˜ê·¸ë¡œ ìœ„ì¹˜ ì´ë™ (í—¤ë” ë“œë˜ê·¸)
- ëª¨ì„œë¦¬/ê°€ì¥ìë¦¬ ë“œë˜ê·¸ë¡œ í¬ê¸° ì¡°ì ˆ
- ìµœì†Œí™” ë²„íŠ¼ (ì¶•ì†Œ)
- ì „ì²´í™”ë©´ ë²„íŠ¼
- ë‹«ê¸° ë²„íŠ¼
- ìµœì†Œ í¬ê¸° ì œí•œ (320x180)

**ê°œë°œ ì‹œ ê²ªì€ ë¬¸ì œ:**
- ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ â†’ `user-select: none` ì ìš©
- ì „ì²´í™”ë©´ API í˜¸í™˜ì„± â†’ `requestFullscreen` + `webkitRequestFullscreen` ë¶„ê¸°
- ë¹„ë””ì˜¤ ë¹„ìœ¨ ìœ ì§€ â†’ `object-fit: contain` ì‚¬ìš©

---

## 3. í•™ìƒ í™”ë©´ ìº¡ì²˜/ê³µìœ  (í•™ë¶€ëª¨ìš©)

í•™ìƒì´ ìì‹ ì˜ í™”ë©´ì„ ìº¡ì²˜í•˜ì—¬ ì±…ìƒ ìœ„ ëª¨ë‹ˆí„°ì— í‘œì‹œí•˜ê³ , í•™ë¶€ëª¨ì—ê²Œ WebRTCë¡œ ìŠ¤íŠ¸ë¦¬ë°í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/hooks/useStudentScreen.js` | í™”ë©´ ìº¡ì²˜ ë° WebRTC ìŠ¤íŠ¸ë¦¬ë° |
| `src/components/metaverse/DeskMonitor.jsx` | ì±…ìƒ ìœ„ 3D ëª¨ë‹ˆí„° |

### useStudentScreen í›…

**íŒŒì¼**: `src/hooks/useStudentScreen.js`

```javascript
import { useStudentScreen } from '../hooks/useStudentScreen'

const studentScreen = useStudentScreen(!isInstructor, roomId)
```

**ë°˜í™˜ê°’:**

| ì†ì„±/ë©”ì„œë“œ | íƒ€ì… | ì„¤ëª… |
|------------|------|------|
| `stream` | MediaStream \| null | ìº¡ì²˜ëœ í™”ë©´ ìŠ¤íŠ¸ë¦¼ |
| `isSharing` | boolean | ê³µìœ  ì¤‘ì¸ì§€ |
| `error` | string \| null | ì—ëŸ¬ ë©”ì‹œì§€ |
| `startCapture()` | function | í™”ë©´ ìº¡ì²˜ ì‹œì‘ |
| `stopCapture()` | function | í™”ë©´ ìº¡ì²˜ ì¤‘ì§€ |

**ì†Œì¼“ ì´ë²¤íŠ¸:**

| ì´ë²¤íŠ¸ | ì„¤ëª… |
|--------|------|
| `student:screen-consent` | í™”ë©´ ê³µìœ  ë™ì˜ ìƒíƒœ ì „ì†¡ |
| `student:screen-start` | í™”ë©´ ê³µìœ  ì‹œì‘ ì•Œë¦¼ |
| `student:screen-stop` | í™”ë©´ ê³µìœ  ì¤‘ì§€ ì•Œë¦¼ |
| `student:screen-request` | ë¶€ëª¨ê°€ í™”ë©´ ìš”ì²­ ì‹œ ìˆ˜ì‹  |
| `student:screen-offer` | ë¶€ëª¨ì—ê²Œ WebRTC Offer ì „ì†¡ |
| `student:screen-answer` | ë¶€ëª¨ë¡œë¶€í„° Answer ìˆ˜ì‹  |
| `student:screen-ice` | ICE Candidate êµí™˜ |

### DeskMonitor ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/DeskMonitor.jsx`

í•™ìƒì´ ì˜ìì— ì•‰ì•˜ì„ ë•Œ ì±…ìƒ ìœ„ì— ë‚˜íƒ€ë‚˜ëŠ” 3D ëª¨ë‹ˆí„°ì…ë‹ˆë‹¤.

```jsx
{isSitting && studentScreen.stream && sittingPosition && (
  <DeskMonitor
    stream={studentScreen.stream}
    position={[
      sittingPosition[0] + 0.9,  // ì˜ì ìœ„ì¹˜ + ì˜¤í”„ì…‹
      sittingPosition[1] + 1.9,
      sittingPosition[2]
    ]}
  />
)}
```

---

## 4. íŒì„œ ê¸°ëŠ¥ (ì¹ íŒ)

ê°•ì‚¬ê°€ íƒœë¸”ë¦¿/ëª¨ë°”ì¼ì—ì„œ ê·¸ë¦¼ì„ ê·¸ë¦¬ë©´ 3D ì¹ íŒì— ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/components/metaverse/Blackboard.jsx` | 3D ì¹ íŒ (Canvas Texture) |
| `src/pages/WhiteboardController.jsx` | íƒœë¸”ë¦¿ìš© ê·¸ë¦¬ê¸° UI |
| `server/sockets/index.js` | ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (whiteboard:*) |

### ë™ì‘ íë¦„

```
[íƒœë¸”ë¦¿ ì»¨íŠ¸ë¡¤ëŸ¬]                [ì„œë²„]                     [ë©”íƒ€ë²„ìŠ¤ ì¹ íŒ]
        â”‚                          â”‚                            â”‚
        â”‚ whiteboard:draw â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
        â”‚ (fromX, fromY,           â”‚ whiteboard:draw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
        â”‚  toX, toY, color,        â”‚                            â”‚
        â”‚  lineWidth, tool)        â”‚                            â”‚
        â”‚                          â”‚                            â”‚
        â”‚                          â”‚            Canvasì— ì„  ê·¸ë¦¬ê¸°
        â”‚                          â”‚            CanvasTexture ì—…ë°ì´íŠ¸
```

### Blackboard ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/Blackboard.jsx`

```jsx
import Blackboard from './Blackboard.jsx'

<Blackboard
  targetMesh={blackboardMeshRef.current}  // ì¹ íŒìœ¼ë¡œ ì‚¬ìš©í•  3D ë©”ì‹œ
  roomId={roomId}
/>
```

**í•µì‹¬ ì½”ë“œ:**
```javascript
// 1. ê³ í•´ìƒë„ Canvas ìƒì„±
const canvas = document.createElement('canvas')
canvas.width = 6144   // 2048 * 3 (UV ìŠ¤ì¼€ì¼ ëŒ€ì‘)
canvas.height = 1536

// 2. CanvasTextureë¡œ ë³€í™˜
const texture = new THREE.CanvasTexture(canvas)
texture.rotation = (Math.PI / 2) + Math.PI  // 270ë„ íšŒì „ (ëª¨ë¸ UVì— ë§ì¶¤)
texture.center.set(0.5, 0.5)

// 3. ê¸°ì¡´ ë©”ì‹œì˜ ì¬ì§ˆì„ êµì²´
targetMesh.material = new THREE.MeshBasicMaterial({
  map: texture,
  toneMapped: false,
})

// 4. ì†Œì¼“ìœ¼ë¡œ ê·¸ë¦¬ê¸° ë°ì´í„° ìˆ˜ì‹  ì‹œ
socketService.on('whiteboard:draw', (drawData) => {
  const ctx = canvas.getContext('2d')

  // ì¢Œí‘œ ë³€í™˜ (0~1 ë¹„ìœ¨ â†’ ìº”ë²„ìŠ¤ í”½ì…€)
  const fromX = drawData.fromX * canvas.width
  const fromY = drawData.fromY * canvas.height
  const toX = drawData.toX * canvas.width
  const toY = drawData.toY * canvas.height

  ctx.strokeStyle = drawData.tool === 'eraser' ? '#1a1a2e' : drawData.color
  ctx.lineWidth = drawData.lineWidth * (canvas.width / 1024)
  ctx.lineCap = 'round'
  ctx.lineJoin = 'round'

  ctx.beginPath()
  ctx.moveTo(fromX, fromY)
  ctx.lineTo(toX, toY)
  ctx.stroke()

  texture.needsUpdate = true  // í…ìŠ¤ì²˜ ì—…ë°ì´íŠ¸ í”Œë˜ê·¸
})
```

### ì†Œì¼“ ì´ë²¤íŠ¸

| ì´ë²¤íŠ¸ | ë°ì´í„° | ì„¤ëª… |
|--------|--------|------|
| `whiteboard:start` | `{ roomId }` | íŒì„œ ì„¸ì…˜ ì‹œì‘ |
| `whiteboard:started` | `{}` | ì„¸ì…˜ ì‹œì‘ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `whiteboard:draw` | drawData (ì•„ë˜ ì°¸ê³ ) | ê·¸ë¦¬ê¸° ë°ì´í„° ì „ì†¡/ìˆ˜ì‹  |
| `whiteboard:clear` | `{ roomId }` | ì¹ íŒ ì§€ìš°ê¸° |
| `whiteboard:cleared` | `{}` | ì§€ìš°ê¸° ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `whiteboard:stop` | `{ roomId }` | íŒì„œ ì„¸ì…˜ ì¢…ë£Œ |

### drawData êµ¬ì¡°

```javascript
{
  fromX: 0.0~1.0,      // ì‹œì‘ì  X (ë¹„ìœ¨)
  fromY: 0.0~1.0,      // ì‹œì‘ì  Y (ë¹„ìœ¨)
  toX: 0.0~1.0,        // ëì  X (ë¹„ìœ¨)
  toY: 0.0~1.0,        // ëì  Y (ë¹„ìœ¨)
  color: '#ffffff',    // ìƒ‰ìƒ
  lineWidth: 5,        // ì„  êµµê¸°
  tool: 'pen' | 'eraser'  // ë„êµ¬
}
```

### íƒœë¸”ë¦¿ ì»¨íŠ¸ë¡¤ëŸ¬

**URL**: `/whiteboard-controller?room={roomId}`

ê°•ì‚¬ê°€ íƒœë¸”ë¦¿/í°ì—ì„œ ì´ URLë¡œ ì ‘ì†í•˜ë©´ í„°ì¹˜ë¡œ ê·¸ë¦¼ì„ ê·¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ê°œë°œ ì‹œ ê²ªì€ ë¬¸ì œ:**
- ìº”ë²„ìŠ¤ ì¢Œí‘œì™€ 3D UV ì¢Œí‘œ ë¶ˆì¼ì¹˜ â†’ íšŒì „/ìŠ¤ì¼€ì¼ ì¡°ì • í•„ìš”
- í„°ì¹˜ ì´ë²¤íŠ¸ vs ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ â†’ ë‘˜ ë‹¤ ì²˜ë¦¬
- ê³ í•´ìƒë„ ìº”ë²„ìŠ¤ ë©”ëª¨ë¦¬ â†’ ì ì ˆí•œ í¬ê¸° íƒ€í˜‘ (6144x1536)

---

## 5. ìŒì„± ì±„íŒ… (ë§ˆì´í¬)

ë°©ì— ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì ê°„ ì‹¤ì‹œê°„ ìŒì„± í†µí™” ê¸°ëŠ¥ì…ë‹ˆë‹¤ (Mesh P2P ë°©ì‹).

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/hooks/useVoiceChat.js` | ìŒì„± ì±„íŒ… ë¡œì§ (WebRTC) |
| `src/utils/webrtc.js` | RTCPeerConnection ì„¤ì • |
| `server/sockets/index.js` | ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (voice:*) |

### useVoiceChat í›…

**íŒŒì¼**: `src/hooks/useVoiceChat.js`

```javascript
import { useVoiceChat } from '../hooks/useVoiceChat'

const voiceChat = useVoiceChat(roomId, students, !isParentObserver)
```

**ë°˜í™˜ê°’:**

| ì†ì„±/ë©”ì„œë“œ | íƒ€ì… | ì„¤ëª… |
|------------|------|------|
| `isMicOn` | boolean | ë§ˆì´í¬ ì¼œì§ ì—¬ë¶€ |
| `error` | string \| null | ì—ëŸ¬ ë©”ì‹œì§€ |
| `connections` | Map | socketId â†’ connectionInfo |
| `turnOnMic()` | function | ë§ˆì´í¬ ì¼œê¸° (ê¶Œí•œ ìš”ì²­) |
| `turnOffMic()` | function | ë§ˆì´í¬ ë„ê¸° |

### ë™ì‘ íë¦„ (Mesh P2P)

```
[ì‚¬ìš©ì A]                    [ì‚¬ìš©ì B]                    [ì‚¬ìš©ì C]
    â”‚                            â”‚                            â”‚
    â”‚ â”€â”€â”€â”€ WebRTC ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
    â”‚<â”€â”€â”€â”€ WebRTC ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
    â”‚                            â”‚                            â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WebRTC ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WebRTC ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                            â”‚                            â”‚
    â”‚                            â”‚ â”€â”€â”€â”€ WebRTC ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                            â”‚<â”€â”€â”€â”€ WebRTC ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

ëª¨ë“  ì‚¬ìš©ìê°€ ì„œë¡œ ì§ì ‘ P2P ì—°ê²°ì„ ë§ºìŠµë‹ˆë‹¤. (Nëª…ì´ë©´ N*(N-1)/2 ì—°ê²°)

### ì†Œì¼“ ì´ë²¤íŠ¸

| ì´ë²¤íŠ¸ | ë°ì´í„° | ì„¤ëª… |
|--------|--------|------|
| `voice:offer` | `{ targetSocketId, offer }` | WebRTC Offer ì „ì†¡ |
| `voice:answer` | `{ targetSocketId, answer }` | WebRTC Answer ì „ì†¡ |
| `voice:ice-candidate` | `{ targetSocketId, candidate }` | ICE Candidate ì „ì†¡ |

### ì˜¤ë””ì˜¤ ì„¤ì •

```javascript
const stream = await navigator.mediaDevices.getUserMedia({
  audio: {
    echoCancellation: true,    // ì—ì½” ì œê±°
    noiseSuppression: true,    // ë…¸ì´ì¦ˆ ì œê±°
    autoGainControl: true,     // ìë™ ê²Œì¸ ì¡°ì ˆ
  },
  video: false,
})
```

### ì›ê²© ì˜¤ë””ì˜¤ ì¬ìƒ

```javascript
// Audio ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± ë° ìë™ ì¬ìƒ
const audioElement = new Audio()
audioElement.autoplay = true
audioElement.srcObject = remoteStream

// Mapì— ì €ì¥ (ê´€ë¦¬ìš©)
audioElementsRef.current.set(targetSocketId, audioElement)
```

**ê°œë°œ ì‹œ ê²ªì€ ë¬¸ì œ:**
- í¬ë¡¬ ìë™ì¬ìƒ ì •ì±… â†’ `autoplay` ì†ì„±ë§Œìœ¼ë¡œ ì¶©ë¶„ (ì˜¤ë””ì˜¤ëŠ” í—ˆìš©)
- ì—°ê²° ëŠê¹€ ê°ì§€ â†’ `onconnectionstatechange` ì´ë²¤íŠ¸ í™œìš©
- ìƒˆ ì‚¬ìš©ì ì…ì¥ ì‹œ ì—°ê²° â†’ `otherUsers` ë³€ê²½ ê°ì§€í•˜ì—¬ ìë™ ì—°ê²°

---

## 6. í…ìŠ¤íŠ¸ ì±„íŒ…

ë°©ì— ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì ê°„ ì‹¤ì‹œê°„ í…ìŠ¤íŠ¸ ì±„íŒ… ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/hooks/useChat.js` | ì±„íŒ… ë¡œì§ |
| `src/components/metaverse/ChatBox.jsx` | ê²Œì„ ìŠ¤íƒ€ì¼ ì±„íŒ… UI |
| `server/sockets/index.js` | ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (chat:*) |

### useChat í›…

**íŒŒì¼**: `src/hooks/useChat.js`

```javascript
import { useChat } from '../hooks/useChat'

const chat = useChat(roomId, !isParentObserver)
```

**ë°˜í™˜ê°’:**

| ì†ì„±/ë©”ì„œë“œ | íƒ€ì… | ì„¤ëª… |
|------------|------|------|
| `messages` | array | ë©”ì‹œì§€ ë°°ì—´ (ìµœê·¼ 8ê°œ) |
| `isInputActive` | boolean | ì…ë ¥ì°½ í™œì„±í™” ì—¬ë¶€ |
| `inputText` | string | í˜„ì¬ ì…ë ¥ í…ìŠ¤íŠ¸ |
| `messagesEndRef` | ref | ìë™ ìŠ¤í¬ë¡¤ìš© ref |
| `sendMessage()` | function | ë©”ì‹œì§€ ì „ì†¡ |
| `activateInput()` | function | ì…ë ¥ì°½ í™œì„±í™” |
| `deactivateInput()` | function | ì…ë ¥ì°½ ë¹„í™œì„±í™” |
| `handleInputChange(text)` | function | ì…ë ¥ í…ìŠ¤íŠ¸ ë³€ê²½ |

### ChatBox ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/ChatBox.jsx`

ê²Œì„ ìŠ¤íƒ€ì¼ì˜ ì±„íŒ… UIì…ë‹ˆë‹¤.

```jsx
<ChatBox
  messages={chat.messages}
  isInputActive={chat.isInputActive}
  inputText={chat.inputText}
  messagesEndRef={chat.messagesEndRef}
  onInputChange={chat.handleInputChange}
  onSendMessage={chat.sendMessage}
  onActivateInput={chat.activateInput}
  onDeactivateInput={chat.deactivateInput}
/>
```

**ì£¼ìš” ê¸°ëŠ¥:**
- Enter í‚¤ë¡œ ì…ë ¥ì°½ í™œì„±í™”
- ESC í‚¤ë¡œ ì…ë ¥ ì·¨ì†Œ
- 30ì´ˆ í›„ ë©”ì‹œì§€ ìë™ í˜ì´ë“œ ì•„ì›ƒ
- ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ì…ì¥/í‡´ì¥ ì•Œë¦¼)
- ìµœëŒ€ 8ê°œ ë©”ì‹œì§€ë§Œ í‘œì‹œ (ì˜¤ë˜ëœ ê²ƒë¶€í„° ì‚­ì œ)

**ë©”ì‹œì§€ êµ¬ì¡°:**
```javascript
{
  id: 'timestamp-socketId',
  userId: 'user-id',
  userName: 'ì‚¬ìš©ì ì´ë¦„',
  message: 'ë©”ì‹œì§€ ë‚´ìš©',
  timestamp: '2025-01-20T12:00:00.000Z',
  type: 'text' | 'system'
}
```

**ê°œë°œ ì‹œ ê²ªì€ ë¬¸ì œ:**
- ì±„íŒ… ì…ë ¥ ì¤‘ WASD ì´ë™ â†’ `isInputActive` ìƒíƒœë¡œ í‚¤ ì…ë ¥ ì°¨ë‹¨
- ë©”ì‹œì§€ ëˆ„ì ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì¦ê°€ â†’ ìµœëŒ€ 8ê°œë§Œ ìœ ì§€
- í˜ì´ë“œ ì•„ì›ƒ íƒ€ì´ë° â†’ `setInterval`ë¡œ í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸

---

## 7. CCTV ê¸°ëŠ¥

ê°•ì‚¬ê°€ CCTVë¥¼ ì¼œë©´ í•™ë¶€ëª¨ê°€ ê°•ì˜ì‹¤ ì˜ìƒì„ ì‹œì²­í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/components/metaverse/CCTVCamera.jsx` | CCTV ì¹´ë©”ë¼ ë° ìŠ¤íŠ¸ë¦¬ë° |

### CCTVCamera ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/CCTVCamera.jsx`

```jsx
<CCTVCamera
  classroomId={classroomId}
  isEnabled={isCCTVEnabled}
  onStreamReady={(stream) => handleCCTVStream(stream)}
/>
```

**í•µì‹¬ ì½”ë“œ:**
```javascript
// WebGL ìº”ë²„ìŠ¤ ìŠ¤íŠ¸ë¦¼ ìº¡ì²˜
const canvas = gl.domElement
const stream = canvas.captureStream(30) // 30 FPS

// ì„œë²„ì— CCTV í™œì„±í™” ì•Œë¦¼
socketService.emit('cctv:enable', { classroomId })
```

### CCTVCameraIndicator ì»´í¬ë„ŒíŠ¸

3D ì”¬ì— CCTV ì¹´ë©”ë¼ ëª¨ë¸ì„ í‘œì‹œí•©ë‹ˆë‹¤.

```jsx
<CCTVCameraIndicator
  position={[0, 5, -15]}  // êµì‹¤ ë’·ë²½
  isActive={isCCTVEnabled}
/>
```

### ì†Œì¼“ ì´ë²¤íŠ¸

| ì´ë²¤íŠ¸ | ì„¤ëª… |
|--------|------|
| `cctv:enable` | CCTV í™œì„±í™” |
| `cctv:disable` | CCTV ë¹„í™œì„±í™” |
| `cctv:viewer-joined` | í•™ë¶€ëª¨ê°€ ì‹œì²­ ì‹œì‘ |

---

# Part 2: ë©”íƒ€ë²„ìŠ¤ ê¸°ëŠ¥

---

## 8. ì˜ì/êµíƒ ìƒí˜¸ì‘ìš©

3D ê³µê°„ì—ì„œ ì˜ìì— ì•‰ê±°ë‚˜ êµíƒì— ì„œëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/components/metaverse/InteractiveObject.jsx` | ìƒí˜¸ì‘ìš© ì˜ì—­ ì„¼ì„œ |
| `src/components/metaverse/Player.jsx` | í”Œë ˆì´ì–´ ì•‰ê¸°/ì„œê¸° ë¡œì§ |
| `src/components/metaverse/MetaverseScene.jsx` | ìƒí˜¸ì‘ìš© ì²˜ë¦¬ |

### InteractiveObject ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/InteractiveObject.jsx`

Rapier ë¬¼ë¦¬ ì—”ì§„ì˜ ì„¼ì„œ ì½œë¼ì´ë”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```jsx
import InteractiveObject from './InteractiveObject.jsx'

<InteractiveObject
  position={[0, 0, 0]}           // ì„¼ì„œ ìœ„ì¹˜
  sittingPosition={[0, 0.5, 0]}  // ì‹¤ì œ ì•‰ëŠ” ìœ„ì¹˜
  size={[1, 1, 1]}               // ì„¼ì„œ í¬ê¸°
  objectId="chair-1"             // ê³ ìœ  ID
  label="ì˜ìì— ì•‰ê¸°"             // UI í‘œì‹œ í…ìŠ¤íŠ¸
  type="sit"                     // 'sit' | 'stand'
  onNearChange={handleNearChange}  // ì§„ì…/í‡´ì¥ ì½œë°±
/>
```

**Props:**

| Prop | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `position` | [x, y, z] | ì„¼ì„œ ì½œë¼ì´ë” ìœ„ì¹˜ |
| `sittingPosition` | [x, y, z] | ì‹¤ì œë¡œ ì•‰ëŠ” ìœ„ì¹˜ |
| `size` | [w, h, d] | ì„¼ì„œ í¬ê¸° |
| `objectId` | string | ê³ ìœ  ì‹ë³„ì |
| `label` | string | UIì— í‘œì‹œí•  í…ìŠ¤íŠ¸ |
| `type` | 'sit' \| 'stand' | ì˜ì/êµíƒ êµ¬ë¶„ |
| `onNearChange` | function | ì§„ì…/í‡´ì¥ ì½œë°± |

### ë™ì‘ íë¦„

```
1. í”Œë ˆì´ì–´ê°€ InteractiveObject ì„¼ì„œ ì˜ì—­ì— ì§„ì…
   â””â”€> onIntersectionEnter íŠ¸ë¦¬ê±°
   â””â”€> onNearChange({ isNear: true, objectId, label, type, position })

2. UIì— "F í‚¤ë¥¼ ëˆŒëŸ¬ ìƒí˜¸ì‘ìš©" í‘œì‹œ

3. F í‚¤ ëˆ„ë¦„
   â””â”€> handleObjectInteract(objectId, type, position) í˜¸ì¶œ
   â””â”€> playerRef.current.sit(position, type) í˜¸ì¶œ

4. Player.jsxì—ì„œ ì•‰ê¸° ì²˜ë¦¬
   â””â”€> RigidBodyë¥¼ kinematicìœ¼ë¡œ ë³€ê²½ (ë¬¼ë¦¬ ë¬´ì‹œ)
   â””â”€> ì§€ì •ëœ ìœ„ì¹˜ë¡œ í…”ë ˆí¬íŠ¸
   â””â”€> ë°©í–¥ ì„¤ì • (ì˜ì: +X, êµíƒ: -X)
```

### Player ì•‰ê¸°/ì„œê¸° ë©”ì„œë“œ

```javascript
// Player refë¥¼ í†µí•´ ì ‘ê·¼
const playerRef = useRef(null)

// ì•‰ê¸°
playerRef.current.sit([x, y, z], 'sit')   // ì˜ì - +X ë°©í–¥ ë°”ë¼ë´„
playerRef.current.sit([x, y, z], 'stand') // êµíƒ - -X ë°©í–¥ ë°”ë¼ë´„

// ì¼ì–´ì„œê¸°
playerRef.current.stand()

// ìƒíƒœ í™•ì¸
playerRef.current.isSitting()  // boolean
```

**í•µì‹¬ ì½”ë“œ (Player.jsx):**
```javascript
sit: (position, type) => {
  // typeì— ë”°ë¼ ë°”ë¼ë³´ëŠ” ë°©í–¥ ì„¤ì •
  let targetRotation
  if (type === 'sit') {
    // ì˜ì: +X ë°©í–¥ (90ë„)
    targetRotation = new THREE.Quaternion().setFromAxisAngle(
      new THREE.Vector3(0, 1, 0),
      Math.PI / 2
    )
  } else if (type === 'stand') {
    // êµíƒ: -X ë°©í–¥ (-90ë„)
    targetRotation = new THREE.Quaternion().setFromAxisAngle(
      new THREE.Vector3(0, 1, 0),
      -Math.PI / 2
    )
  }

  // RigidBodyë¥¼ kinematicìœ¼ë¡œ ë³€ê²½ (ë¬¼ë¦¬ ì¶©ëŒ ë¬´ì‹œ)
  bodyRef.current.setBodyType(1, true)  // 1 = KinematicPositionBased

  // ì•‰ëŠ” ìœ„ì¹˜ë¡œ í…”ë ˆí¬íŠ¸
  bodyRef.current.setTranslation({ x: position[0], y: position[1], z: position[2] }, true)
  bodyRef.current.setRotation({ x, y, z, w }, true)
  bodyRef.current.setLinvel({ x: 0, y: 0, z: 0 }, true)  // ì†ë„ ì´ˆê¸°í™”
  bodyRef.current.setAngvel({ x: 0, y: 0, z: 0 }, true)  // ê°ì†ë„ ì´ˆê¸°í™”
}

stand: () => {
  // ì˜ì ì•ìœ¼ë¡œ ì´ë™ (ë¼ì§€ ì•Šë„ë¡)
  const currentPos = bodyRef.current.translation()
  bodyRef.current.setTranslation({
    x: currentPos.x,
    y: currentPos.y,
    z: currentPos.z + 0.8  // ì•ìœ¼ë¡œ 0.8 ì´ë™
  }, true)

  // RigidBodyë¥¼ ë‹¤ì‹œ dynamicìœ¼ë¡œ ë³€ê²½
  bodyRef.current.setBodyType(0, true)  // 0 = Dynamic
}
```

**ê°œë°œ ì‹œ ê²ªì€ ë¬¸ì œ:**
- ì•‰ì€ í›„ ë¬¼ë¦¬ ì¶©ëŒë¡œ íŠ•ê²¨ë‚˜ê° â†’ `setBodyType(1)` (kinematic)ìœ¼ë¡œ ë³€ê²½
- ì¼ì–´ì„¤ ë•Œ ì˜ìì— ë¼ì„ â†’ ì¼ì–´ì„¤ ë•Œ ì•ìœ¼ë¡œ 0.8 ì´ë™
- ì•‰ì€ ìƒíƒœì—ì„œ íšŒì „ â†’ `setAngvel({ x: 0, y: 0, z: 0 })` ìœ¼ë¡œ ê³ ì •

---

## 9. í¬íƒˆ ì‹œìŠ¤í…œ (ë§µ ì´ë™)

ë§µ ê°„ ì´ë™ì„ ìœ„í•œ í¬íƒˆ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/components/metaverse/Portal.jsx` | í¬íƒˆ ì»´í¬ë„ŒíŠ¸ |
| `src/components/metaverse/MapModel.jsx` | ë§µ ëª¨ë¸ + í¬íƒˆ ë°°ì¹˜ |

### Portal ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/Portal.jsx`

```jsx
import Portal from './Portal.jsx'

<Portal
  position={[0, 0, 0]}
  size={[2, 3, 2]}
  targetMap="school"
  label="í•™êµë¡œ ì´ë™"
  onNearChange={handlePortalNearChange}
/>
```

**Props:**

| Prop | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `position` | [x, y, z] | í¬íƒˆ ìœ„ì¹˜ |
| `size` | [w, h, d] | í¬íƒˆ í¬ê¸° |
| `targetMap` | string | ì´ë™í•  ë§µ ì´ë¦„ |
| `label` | string | UIì— í‘œì‹œí•  í…ìŠ¤íŠ¸ |
| `onNearChange` | function | ì§„ì…/í‡´ì¥ ì½œë°± |

**ë™ì‘:**
1. ì„¼ì„œ ì½œë¼ì´ë”ë¡œ í”Œë ˆì´ì–´ ì§„ì… ê°ì§€
2. `onNearChange({ isNear: true, targetMap, label })` í˜¸ì¶œ
3. F í‚¤ ëˆ„ë¥´ë©´ `handleMapChange(targetMap)` í˜¸ì¶œ
4. ë§µ ì „í™˜ + í”Œë ˆì´ì–´ ìœ„ì¹˜ ë¦¬ì…‹

---

## 10. ë¬¸ ì‹œìŠ¤í…œ (ê°•ì˜ì‹¤ ì…ì¥)

ê°•ì˜ì‹¤ ì…ì¥/í‡´ì¥ì„ ìœ„í•œ ë¬¸ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/components/metaverse/Door.jsx` | ë¬¸ ì„¼ì„œ ì»´í¬ë„ŒíŠ¸ |
| `src/components/metaverse/MetaverseScene.jsx` | ë¬¸ ìƒí˜¸ì‘ìš© ì²˜ë¦¬ |

### Door ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/Door.jsx`

```jsx
import Door from './Door.jsx'

<Door
  position={[-52.88, 1.5, -20.5]}
  size={[2, 3, 0.5]}
  doorId="door1_enter"
  label="ê°•ì˜ì‹¤ A ì…ì¥"
  onNearChange={handleDoorNearChange}
/>
```

### ì…ì¥/í‡´ì¥ êµ¬ë¶„

- `doorId`ê°€ `_enter`ë¡œ ëë‚˜ë©´ ì…ì¥ ë¬¸
- `doorId`ê°€ `_exit`ë¡œ ëë‚˜ë©´ í‡´ì¥ ë¬¸

### handleDoorEnter ë¡œì§

```javascript
const handleDoorEnter = async (doorId, teleportTo, playAnimation, isOpened) => {
  // ì• ë‹ˆë©”ì´ì…˜ ë¬¸ ì²˜ë¦¬
  if (playAnimation) {
    playAnimation()
    return
  }

  // í…”ë ˆí¬íŠ¸ ì²˜ë¦¬
  if (teleportTo) {
    playerBodyRef.current.setTranslation({
      x: teleportTo[0],
      y: teleportTo[1],
      z: teleportTo[2]
    }, true)
    return
  }

  // ì…ì¥ ì²˜ë¦¬ (ê¶Œí•œ í™•ì¸)
  if (doorId.endsWith('_enter')) {
    const baseDoorId = doorId.replace('_enter', '')

    // ê°•ì˜ì‹¤ Aë§Œ ê¶Œí•œ í™•ì¸
    if (baseDoorId === 'door1') {
      const response = await api.get(`/classrooms/${classroomAId}/check-access`)
      if (!response.hasAccess) {
        alert(response.message)
        return
      }
    }

    // í…”ë ˆí¬íŠ¸
    const destination = enterDestinations[baseDoorId]
    playerBodyRef.current.setTranslation({ x, y, z }, true)
  }

  // í‡´ì¥ ì²˜ë¦¬ (í•­ìƒ í—ˆìš©)
  if (doorId.endsWith('_exit')) {
    const destination = exitDestinations[baseDoorId]
    playerBodyRef.current.setTranslation({ x, y, z }, true)
  }
}
```

---

## 11. ë©€í‹°í”Œë ˆì´ì–´ ë™ê¸°í™”

ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ì˜ ìœ„ì¹˜/íšŒì „/ì• ë‹ˆë©”ì´ì…˜ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/components/metaverse/OtherPlayer.jsx` | ë‹¤ë¥¸ í”Œë ˆì´ì–´ ë Œë”ë§ |
| `src/components/metaverse/MetaverseScene.jsx` | í”Œë ˆì´ì–´ ê´€ë¦¬ |
| `server/sockets/index.js` | ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (player:*) |

### ë™ì‘ íë¦„

```
[ë‚´ í´ë¼ì´ì–¸íŠ¸]                 [ì„œë²„]                    [ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸]
      â”‚                          â”‚                            â”‚
      â”‚ player:move â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
      â”‚ (position, rotation,     â”‚ player:moved â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚  animation)              â”‚                            â”‚
      â”‚                          â”‚                            â”‚
      â”‚                          â”‚                            â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ player:moved â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                          â”‚                            â”‚
```

### ì†Œì¼“ ì´ë²¤íŠ¸

| ì´ë²¤íŠ¸ | ë°©í–¥ | ë°ì´í„° |
|--------|------|--------|
| `player:move` | Client â†’ Server | `{ roomId, position, rotation, animation }` |
| `player:moved` | Server â†’ Room | `{ socketId, userId, user, position, rotation, animation }` |
| `room:users` | Server â†’ Client | ì…ì¥ ì‹œ ê¸°ì¡´ ì‚¬ìš©ì ëª©ë¡ |
| `room:user-joined` | Server â†’ Room | ìƒˆ ì‚¬ìš©ì ì…ì¥ |
| `room:user-left` | Server â†’ Room | ì‚¬ìš©ì í‡´ì¥ |

### ìœ„ì¹˜ ì „ì†¡ ìµœì í™”

```javascript
// ì¼ì • ê±°ë¦¬ ì´ìƒ ì´ë™í–ˆì„ ë•Œë§Œ ì „ì†¡ (ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ê°ì†Œ)
const distance = Math.sqrt(
  Math.pow(position.x - lastPositionSentRef.current.x, 2) +
  Math.pow(position.y - lastPositionSentRef.current.y, 2) +
  Math.pow(position.z - lastPositionSentRef.current.z, 2)
)

if (distance > 0.1) {  // 0.1 ì´ìƒ ì´ë™ ì‹œ
  socketService.emit('player:move', {
    roomId,
    position: [position.x, position.y, position.z],
    rotation: rotationY,
    animation: playerRef.current?.isMoving?.() ? 'walk' : 'idle',
  })
  lastPositionSentRef.current = position
}
```

### OtherPlayer ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/OtherPlayer.jsx`

```jsx
<OtherPlayer
  key={player.socketId}
  socketId={player.socketId}
  user={player.user}
  position={player.position}      // [x, y, z]
  rotation={player.rotation}      // Yì¶• íšŒì „ (ë¼ë””ì•ˆ)
  animation={player.animation}    // 'idle' | 'walk'
/>
```

**íŠ¹ì§•:**
- ìœ„ì¹˜/íšŒì „ ë³´ê°„ (lerp) ì ìš©ìœ¼ë¡œ ë¶€ë“œëŸ¬ìš´ ì´ë™
- ì´ë¦„í‘œ Billboard (í•­ìƒ ì¹´ë©”ë¼ë¥¼ ë°”ë¼ë´„)
- CharacterModel ì¬ì‚¬ìš©

---

## 12. ìºë¦­í„° ëª¨ë¸ ë° ì• ë‹ˆë©”ì´ì…˜

GLTF ìºë¦­í„° ëª¨ë¸ ë¡œë”© ë° ì• ë‹ˆë©”ì´ì…˜ ì „í™˜ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/components/metaverse/CharacterModel.jsx` | ìºë¦­í„° ëª¨ë¸ ë° ì• ë‹ˆë©”ì´ì…˜ |
| `public/models/BaseCharacter.gltf` | ìºë¦­í„° ëª¨ë¸ íŒŒì¼ |

### CharacterModel ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/CharacterModel.jsx`

```jsx
import CharacterModel from './CharacterModel.jsx'

<CharacterModel
  isMoving={isMoving}
  isSitting={isSitting}
  scale={0.8}
/>
```

**Props:**

| Prop | íƒ€ì… | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|------|--------|------|
| `isMoving` | boolean | false | ì´ë™ ì¤‘ì¸ì§€ |
| `isSitting` | boolean | false | ì•‰ì•„ìˆëŠ”ì§€ |
| `scale` | number | 0.8 | ìºë¦­í„° í¬ê¸° |

### ì• ë‹ˆë©”ì´ì…˜ ì „í™˜ ë¡œì§

```javascript
const IDLE = 'Idle'
const WALK = 'Walk'
const RUN = 'Run'
const SITDOWN = 'SitDown'

useEffect(() => {
  const idleAction = actions[IDLE]
  const walkAction = actions[WALK] || actions.Walking
  const runAction = actions[RUN]
  const sitAction = actions[SITDOWN]

  let targetAction
  if (isSitting) {
    targetAction = sitAction
    // SitDownì€ í•œ ë²ˆë§Œ ì¬ìƒí•˜ê³  ë§ˆì§€ë§‰ í”„ë ˆì„ì—ì„œ ë©ˆì¶¤
    targetAction.setLoop(THREE.LoopOnce, 1)
    targetAction.clampWhenFinished = true
  } else {
    targetAction = isMoving ? (runAction || walkAction) : idleAction
    targetAction.setLoop(THREE.LoopRepeat)
  }

  // í˜ì´ë“œ ì¸/ì•„ì›ƒìœ¼ë¡œ ë¶€ë“œëŸ¬ìš´ ì „í™˜
  targetAction.reset().fadeIn(0.3).play()
  others.forEach((act) => {
    if (act !== targetAction) act.fadeOut(0.3)
  })
}, [isMoving, isSitting, actions])
```

### ëª¨ë¸ ë³µì œ (ë©€í‹°í”Œë ˆì´ì–´ìš©)

```javascript
import { SkeletonUtils } from 'three-stdlib'

// GLTF ëª¨ë¸ì„ ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‚¬ìš©í•  ë•ŒëŠ” ë°˜ë“œì‹œ ë³µì œ
const clonedScene = useMemo(() => {
  return SkeletonUtils.clone(scene)
}, [scene])
```

**ì¤‘ìš”: ì• ë‹ˆë©”ì´ì…˜ ì•¡ì…˜ ì°¾ê¸°**
```javascript
// âŒ ì˜ëª»ëœ ë°©ë²• (ìˆœì„œ ë³´ì¥ ì•ˆ ë¨)
const action = Object.values(actions)[0]

// âœ… ì˜¬ë°”ë¥¸ ë°©ë²• (ì´ë¦„ìœ¼ë¡œ ì°¾ê¸°)
const action = actions['Idle']
const action = actions.Idle
```

---

## 13. ì¹´ë©”ë¼ ì‹œìŠ¤í…œ

í¬ì¸í„° ë½ ê¸°ë°˜ 3ì¸ì¹­/1ì¸ì¹­ ì¹´ë©”ë¼ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/components/metaverse/ThirdPersonCamera.jsx` | ì¹´ë©”ë¼ ì»´í¬ë„ŒíŠ¸ |

### ThirdPersonCamera ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/metaverse/ThirdPersonCamera.jsx`

```jsx
<ThirdPersonCamera
  target={playerRef}
  onCameraRotate={handleCameraRotate}
  distance={isFirstPerson ? 0 : 10}
  height={isFirstPerson ? 2.0 : 6}
/>
```

**Props:**

| Prop | íƒ€ì… | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|------|--------|------|
| `target` | ref | í•„ìˆ˜ | ë”°ë¼ê°ˆ ëŒ€ìƒ |
| `onCameraRotate` | function | - | ì¹´ë©”ë¼ íšŒì „ ê°ë„ ì½œë°± |
| `distance` | number | 10 | ì¹´ë©”ë¼ ê±°ë¦¬ (0ì´ë©´ 1ì¸ì¹­) |
| `height` | number | 6 | ì¹´ë©”ë¼ ë†’ì´ |

### ë™ì‘ ë°©ì‹

1. **í¬ì¸í„° ë½**: ìº”ë²„ìŠ¤ í´ë¦­ ì‹œ ë§ˆìš°ìŠ¤ ì»¤ì„œ ì ê¸ˆ
2. **ë§ˆìš°ìŠ¤ ì´ë™**: ì¹´ë©”ë¼ íšŒì „ (azimuth, elevation)
3. **ESC**: í¬ì¸í„° ë½ í•´ì œ
4. **1ì¸ì¹­/3ì¸ì¹­ ì „í™˜**: V í‚¤ ë˜ëŠ” `distance` prop

### í•µì‹¬ ì½”ë“œ

```javascript
// í¬ì¸í„° ë½ ì„¤ì •
useEffect(() => {
  const handleClick = () => {
    canvas.requestPointerLock()
  }

  const handleMouseMove = (e) => {
    if (document.pointerLockElement === canvas) {
      targetAzimuth.current -= e.movementX * MOUSE_SENSITIVITY
      targetElevation.current += e.movementY * MOUSE_SENSITIVITY
      // ìˆ˜ì§ ê°ë„ ì œí•œ
      targetElevation.current = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, targetElevation.current))
    }
  }

  canvas.addEventListener('click', handleClick)
  document.addEventListener('mousemove', handleMouseMove)
}, [])

// ì¹´ë©”ë¼ ìœ„ì¹˜ ê³„ì‚° (3ì¸ì¹­)
useFrame(() => {
  const horizontalDistance = distance * Math.cos(currentElevation.current)
  const offsetX = horizontalDistance * Math.sin(currentAzimuth.current)
  const offsetZ = horizontalDistance * Math.cos(currentAzimuth.current)
  const offsetY = height + distance * Math.sin(currentElevation.current)

  const desiredPosition = new THREE.Vector3(
    targetPosition.x + offsetX,
    smoothTargetY.current + offsetY,
    targetPosition.z + offsetZ
  )

  // ë¶€ë“œëŸ¬ìš´ ì´ë™
  currentPosition.current.lerp(desiredPosition, xzLerpAlpha)
  camera.position.copy(currentPosition.current)
  camera.lookAt(targetPosition)

  // í”Œë ˆì´ì–´ì—ê²Œ ì¹´ë©”ë¼ ê°ë„ ì „ë‹¬ (ì´ë™ ë°©í–¥ ê³„ì‚°ìš©)
  onCameraRotate?.(currentAzimuth.current)
})
```

**ì„¤ì • ìƒìˆ˜:**
```javascript
const DEFAULT_CAMERA_DISTANCE = 10
const DEFAULT_CAMERA_HEIGHT = 6
const SMOOTH_FACTOR_XZ = 5      // ìˆ˜í‰ ì´ë™ ë¶€ë“œëŸ¬ì›€
const SMOOTH_FACTOR_Y = 2       // ìˆ˜ì§ ì´ë™ ë¶€ë“œëŸ¬ì›€
const MOUSE_SENSITIVITY = 0.002
const ROTATION_SMOOTHING = 10   // íšŒì „ ìŠ¤ë¬´ë”©
```

---

## 14. í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤

WASD ì´ë™, Shift ë‹¬ë¦¬ê¸° ë“± í‚¤ë³´ë“œ ì…ë ¥ì„ ì²˜ë¦¬í•˜ëŠ” ì»¤ìŠ¤í…€ í›…ì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/components/metaverse/useKeyboardControls.js` | í‚¤ë³´ë“œ ì…ë ¥ í›… |

### useKeyboardControls í›…

**íŒŒì¼**: `src/components/metaverse/useKeyboardControls.js`

```javascript
import { useKeyboardControls } from './useKeyboardControls.js'

const { forward, backward, left, right, shift, jump, log } = useKeyboardControls(isInputDisabled)
```

**ë°˜í™˜ê°’:**

| í‚¤ | íƒ€ì… | í‚¤ ë°”ì¸ë”© |
|----|------|----------|
| `forward` | boolean | W, ArrowUp |
| `backward` | boolean | S, ArrowDown |
| `left` | boolean | A, ArrowLeft |
| `right` | boolean | D, ArrowRight |
| `shift` | boolean | ShiftLeft, ShiftRight |
| `jump` | boolean | Space |
| `log` | boolean | C |

**íŠ¹ì§•:**
- `isInputDisabled`ê°€ trueë©´ ëª¨ë“  ì…ë ¥ ë¬´ì‹œ (ì±„íŒ… ì…ë ¥ ì¤‘ ë“±)
- `keydown`/`keyup` ì´ë²¤íŠ¸ë¡œ ìƒíƒœ ê´€ë¦¬
- Space í‚¤ëŠ” `preventDefault()` í˜¸ì¶œ (í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€)

---

## 15. í”Œë ˆì´ì–´ ë¬¼ë¦¬ ë° ì´ë™

Rapier ë¬¼ë¦¬ ì—”ì§„ ê¸°ë°˜ í”Œë ˆì´ì–´ ì´ë™ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/components/metaverse/Player.jsx` | í”Œë ˆì´ì–´ ì»´í¬ë„ŒíŠ¸ |

### ë¬¼ë¦¬ ì„¤ì •

```jsx
<RigidBody
  ref={bodyRef}
  type="dynamic"
  colliders={false}
  position={START_POS}
  enabledRotations={[false, true, false]}  // Yì¶•ë§Œ íšŒì „
  mass={1}
  linearDamping={0.5}
>
  <CapsuleCollider
    args={[CAPSULE_HALF_HEIGHT, CAPSULE_RADIUS]}
    position={[0, CAPSULE_Y_OFFSET, 0]}
    friction={1}
    restitution={0}
  />
</RigidBody>
```

### ë§µë³„ ì„¤ì •

```javascript
const MAP_SETTINGS = {
  main: {
    startPosition: [-1.91, 2, 32.55],
    characterScale: 0.8,
    capsuleHalfHeight: 0.8,
    capsuleRadius: 0.52,
    capsuleYOffset: 1.28,
  },
  school: {
    startPosition: [-1.32, 2, -14.63],
    characterScale: 0.8,
    capsuleHalfHeight: 0.8,
    capsuleRadius: 0.52,
    capsuleYOffset: 1.28,
  },
}
```

### ì´ë™ ì†ë„

```javascript
const WALK_SPEED = 8
const RUN_SPEED = 18
const STEP_UP_SPEED = 4  // ê³„ë‹¨ ì˜¤ë¥´ê¸° ì†ë„
```

### ì´ë™ ë¡œì§

```javascript
useFrame(() => {
  // ì¹´ë©”ë¼ ê¸°ì¤€ ë°©í–¥ ë²¡í„°
  const direction = new THREE.Vector3()
  if (forward) direction.z -= 1
  if (backward) direction.z += 1
  if (left) direction.x -= 1
  if (right) direction.x += 1

  if (direction.lengthSq() > 0) {
    direction.normalize()

    // ì¹´ë©”ë¼ ê°ë„ë§Œí¼ ë°©í–¥ ë²¡í„°ë¥¼ íšŒì „
    const cameraAngle = cameraAngleRef.current
    const rotatedDirection = new THREE.Vector3()
    rotatedDirection.x = direction.x * Math.cos(cameraAngle) + direction.z * Math.sin(cameraAngle)
    rotatedDirection.z = direction.z * Math.cos(cameraAngle) - direction.x * Math.sin(cameraAngle)

    // ìºë¦­í„°ê°€ ì´ë™ ë°©í–¥ì„ ë°”ë¼ë³´ë„ë¡
    const targetAngle = Math.atan2(rotatedDirection.x, rotatedDirection.z)
    const targetQuaternion = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0, 1, 0), targetAngle)
    currentRotationRef.current.slerp(targetQuaternion, 0.25)

    // ê³„ë‹¨ ê°ì§€ (ë§‰í˜€ìˆìœ¼ë©´ ìœ„ë¡œ ë°€ì–´ì¤Œ)
    const speed = shift ? RUN_SPEED : WALK_SPEED
    const actualSpeed = Math.sqrt(linvel.x ** 2 + linvel.z ** 2)
    const isBlocked = actualSpeed < speed * 0.45
    const isGrounded = Math.abs(linvel.y) < 2

    let yVel = linvel.y
    if (isBlocked && isGrounded) {
      yVel = Math.max(linvel.y, STEP_UP_SPEED)
    }

    // ì†ë„ ì„¤ì •
    body.setLinvel({
      x: rotatedDirection.x * speed,
      y: yVel,
      z: rotatedDirection.z * speed,
    }, true)
  }
})
```

### ë¦¬ìŠ¤í° (ë‚™ì‚¬ ë°©ì§€)

```javascript
// ë§µ ë°‘ìœ¼ë¡œ ë–¨ì–´ì¡Œì„ ë•Œ ìë™ ë¦¬ìŠ¤í°
if (pos.y < -3) {
  body.setTranslation({ x: START_POS[0], y: START_POS[1], z: START_POS[2] }, true)
  body.setLinvel({ x: 0, y: 0, z: 0 }, true)
}
```

---

# Part 3: íŠ¹ìˆ˜ ê¸°ëŠ¥

---

## 16. í•™ë¶€ëª¨ ì°¸ê´€ ëª¨ë“œ

í•™ë¶€ëª¨ê°€ ìë…€ì˜ ìˆ˜ì—…ì„ íˆ¬ëª…í•˜ê²Œ ì°¸ê´€í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### URL íŒŒë¼ë¯¸í„°

```
/metaverse?mode=observer&studentId=xxx
```

### ì°¸ê´€ ëª¨ë“œ íŠ¹ì§•

| ê¸°ëŠ¥ | ì°¸ê´€ì |
|------|--------|
| ìºë¦­í„° í‘œì‹œ | âŒ (íˆ¬ëª…) |
| ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œ ë³´ì„ | âŒ |
| ì±„íŒ… ì „ì†¡ | âŒ (ì½ê¸°ë§Œ ê°€ëŠ¥) |
| ë§ˆì´í¬ | âŒ |
| ì˜ì/êµíƒ ìƒí˜¸ì‘ìš© | âŒ |
| í™”ë©´ ê³µìœ  ì‹œì²­ | âœ… |
| ìë…€ í™”ë©´ ë³´ê¸° | âœ… |
| ì´ë™ | âœ… |

### ì°¸ê´€ì ê°ì§€ ë¡œì§

```javascript
// URL íŒŒë¼ë¯¸í„° í™•ì¸
const isObserverMode = urlParams.get('mode') === 'observer'
const observerStudentId = urlParams.get('studentId')
const isParentObserver = isObserverMode && effectiveUser?.role === 'parent'

// ì°¸ê´€ìëŠ” ìºë¦­í„°ë¥¼ ë Œë”ë§í•˜ì§€ ì•ŠìŒ
<group ref={characterRef} visible={!isFirstPerson && !isInvisible}>
```

### ì„œë²„ ì¸¡ ì²˜ë¦¬

```javascript
// ì°¸ê´€ìëŠ” ë¸Œë¡œë“œìºìŠ¤íŠ¸ì—ì„œ ì œì™¸
if (!user.isObserver) {
  io.to(roomId).emit('room:user-joined', { ... })
}

// ì°¸ê´€ìëŠ” ë‹¤ë¥¸ ì°¸ê´€ìë¥¼ ë³¼ ìˆ˜ ì—†ìŒ
const roomUsers = users.filter(u => !u.isObserver)
```

### í•™ìƒ ìœ„ì¹˜ ì¶”ì  (í•™ë¶€ëª¨ìš©)

```javascript
// í•™ìƒì´ ìœ„ì¹˜ ë³€ê²½ ì‹œ ë¶€ëª¨ì—ê²Œ ì•Œë¦¼
socketService.emit('student:location-update', {
  classroomId: roomId,
  position: [x, y, z],
  locationName,  // 'ìš´ë™ì¥', 'ë³µë„', 'ê°•ì˜ì‹¤ A' ë“±
  mapType: currentMap,
  classroom: currentClassroom,
})
```

---

## 17. ê°•ì˜ì‹¤ ì ‘ê·¼ ê¶Œí•œ ì‹œìŠ¤í…œ

ê°•ì˜ì‹¤ ì…ì¥ ì‹œ ìˆ˜ê°• ì‹ ì²­ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### ë™ì‘ íë¦„

```
1. ë¬¸ ì„¼ì„œ ì˜ì—­ ì§„ì…
2. F í‚¤ ëˆ„ë¦„
3. API í˜¸ì¶œ: GET /classrooms/:id/check-access
4. hasAccessê°€ trueë©´ ì…ì¥, falseë©´ alert
```

### API ì‘ë‹µ êµ¬ì¡°

```javascript
{
  hasAccess: boolean,
  reason: 'instructor' | 'enrolled' | 'admin' | 'not_enrolled',
  message: 'ì ‘ê·¼ í—ˆìš©/ê±°ë¶€ ë©”ì‹œì§€'
}
```

### í´ë¼ì´ì–¸íŠ¸ ì²˜ë¦¬

```javascript
if (baseDoorId === 'door1') {  // ê°•ì˜ì‹¤ A
  try {
    const response = await api.get(`/classrooms/${classroomAId}/check-access`)

    if (!response.hasAccess) {
      alert(response.message || 'êµì‹¤ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
      return
    }
  } catch (error) {
    if (error.response?.status === 401) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.')
    }
    return
  }
}
```

---

# Part 4: ê°œë°œ ê°€ì´ë“œ

---

## 18. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

### í”„ë¡ íŠ¸ì—”ë“œ (.env)

```bash
# Vite í™˜ê²½ë³€ìˆ˜ (VITE_ ì ‘ë‘ì‚¬ í•„ìˆ˜)
VITE_API_URL=http://localhost:3000
VITE_SOCKET_URL=http://localhost:3000
VITE_SUPABASE_URL=https://xxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJxxx

# WebRTC TURN ì„œë²„ (ì„ íƒ)
VITE_TURN_SERVER_URL=turn:your-turn-server.com:3478
VITE_TURN_USERNAME=username
VITE_TURN_CREDENTIAL=password
```

### ë°±ì—”ë“œ (.env)

```bash
PORT=3000
NODE_ENV=development
CORS_ORIGIN=http://localhost:5173

# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_KEY=eyJxxx

# JWT
JWT_SECRET=your-jwt-secret
```

---

## 19. WebRTC ì„¤ì •

### ICE ì„œë²„ ì„¤ì •

**íŒŒì¼**: `src/utils/webrtc.js`

```javascript
export function getIceServers() {
  const iceServers = [
    // STUN ì„œë²„ (NAT í†µê³¼ìš©)
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:stun2.l.google.com:19302' },
  ]

  // TURN ì„œë²„ (Symmetric NAT í†µê³¼ìš©)
  const turnUrl = import.meta.env.VITE_TURN_SERVER_URL
  if (turnUrl) {
    iceServers.push({
      urls: turnUrl,
      username: import.meta.env.VITE_TURN_USERNAME,
      credential: import.meta.env.VITE_TURN_CREDENTIAL,
    })
  } else {
    // ë¬´ë£Œ ê³µê°œ TURN ì„œë²„ (í…ŒìŠ¤íŠ¸/ì†Œê·œëª¨ìš©)
    iceServers.push(
      {
        urls: 'turn:openrelay.metered.ca:80',
        username: 'openrelayproject',
        credential: 'openrelayproject',
      },
      {
        urls: 'turn:openrelay.metered.ca:443',
        username: 'openrelayproject',
        credential: 'openrelayproject',
      },
      {
        urls: 'turn:openrelay.metered.ca:443?transport=tcp',
        username: 'openrelayproject',
        credential: 'openrelayproject',
      }
    )
  }

  return iceServers
}

export function getRTCConfiguration() {
  return {
    iceServers: getIceServers(),
    iceCandidatePoolSize: 10,
  }
}
```

### TURN ì„œë²„ í•„ìš” ìƒí™©

- ëŒ€ì¹­ NAT (Symmetric NAT) ë’¤ì— ìˆëŠ” ì‚¬ìš©ì
- ê¸°ì—… ë°©í™”ë²½ ë’¤ì— ìˆëŠ” ì‚¬ìš©ì
- ëª¨ë°”ì¼ ë„¤íŠ¸ì›Œí¬ (LTE/5G)

### ì¶”ì²œ TURN ì„œë²„ ì„œë¹„ìŠ¤

- Twilio STUN/TURN
- Xirsys
- Metered.ca (ë¬´ë£Œ í”Œëœ ìˆìŒ)
- ìì²´ coturn ì„œë²„

---

## 20. ì†Œì¼“ ì´ë²¤íŠ¸ ì „ì²´ ëª©ë¡

### ë°© ê´€ë¦¬

| ì´ë²¤íŠ¸ | ë°©í–¥ | ì„¤ëª… |
|--------|------|------|
| `user:join` | Câ†’S | ì‚¬ìš©ì ì…ì¥ |
| `user:joined` | Sâ†’C | ì…ì¥ í™•ì¸ |
| `room:users` | Sâ†’C | ë°© ì‚¬ìš©ì ëª©ë¡ |
| `room:user-joined` | Sâ†’Room | ìƒˆ ì‚¬ìš©ì ì…ì¥ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `room:user-left` | Sâ†’Room | ì‚¬ìš©ì í‡´ì¥ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `room:leave` | Câ†’S | ë°© í‡´ì¥ |

### í”Œë ˆì´ì–´ ë™ê¸°í™”

| ì´ë²¤íŠ¸ | ë°©í–¥ | ì„¤ëª… |
|--------|------|------|
| `player:move` | Câ†’S | ìœ„ì¹˜/íšŒì „/ì• ë‹ˆë©”ì´ì…˜ ì „ì†¡ |
| `player:moved` | Sâ†’Room | ë‹¤ë¥¸ í”Œë ˆì´ì–´ì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `location:change` | Câ†’S | ìœ„ì¹˜ ë³€ê²½ (í•™êµ/ê°•ì˜ì‹¤) |
| `location:entered` | Sâ†’Room | ì…ì¥ ì•Œë¦¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |

### í™”ë©´ ê³µìœ  (ê°•ì‚¬)

| ì´ë²¤íŠ¸ | ë°©í–¥ | ì„¤ëª… |
|--------|------|------|
| `screenshare:start` | Câ†’S | ê³µìœ  ì‹œì‘ |
| `screenshare:started` | Sâ†’Room | ê°•ì‚¬ ì •ë³´ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `screenshare:stop` | Câ†’S | ê³µìœ  ì¤‘ì§€ |
| `screenshare:stopped` | Sâ†’Room | ì¤‘ì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `screenshare:offer` | Câ†’C | WebRTC Offer |
| `screenshare:answer` | Câ†’C | WebRTC Answer |
| `screenshare:ice-candidate` | Câ†’C | ICE Candidate |

### ìŒì„± ì±„íŒ…

| ì´ë²¤íŠ¸ | ë°©í–¥ | ì„¤ëª… |
|--------|------|------|
| `voice:offer` | Câ†’C | WebRTC Offer |
| `voice:answer` | Câ†’C | WebRTC Answer |
| `voice:ice-candidate` | Câ†’C | ICE Candidate |

### í…ìŠ¤íŠ¸ ì±„íŒ…

| ì´ë²¤íŠ¸ | ë°©í–¥ | ì„¤ëª… |
|--------|------|------|
| `chat:message` | Câ†’S | ë©”ì‹œì§€ ì „ì†¡ |
| `chat:message` | Sâ†’Room | ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |

### íŒì„œ

| ì´ë²¤íŠ¸ | ë°©í–¥ | ì„¤ëª… |
|--------|------|------|
| `whiteboard:start` | Câ†’S | íŒì„œ ì‹œì‘ |
| `whiteboard:started` | Sâ†’Room | ì‹œì‘ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `whiteboard:draw` | Câ†’Sâ†’Room | ê·¸ë¦¬ê¸° ë°ì´í„° |
| `whiteboard:clear` | Câ†’S | ì§€ìš°ê¸° |
| `whiteboard:cleared` | Sâ†’Room | ì§€ìš°ê¸° ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `whiteboard:stop` | Câ†’S | íŒì„œ ì¢…ë£Œ |

### í•™ìƒ í™”ë©´ (í•™ë¶€ëª¨ìš©)

| ì´ë²¤íŠ¸ | ë°©í–¥ | ì„¤ëª… |
|--------|------|------|
| `student:screen-consent` | Câ†’S | ê³µìœ  ë™ì˜ |
| `student:screen-start` | Câ†’S | ê³µìœ  ì‹œì‘ |
| `student:screen-stop` | Câ†’S | ê³µìœ  ì¤‘ì§€ |
| `student:screen-request` | Sâ†’C | ë¶€ëª¨ê°€ í™”ë©´ ìš”ì²­ |
| `student:screen-offer` | Câ†’C | WebRTC Offer |
| `student:screen-answer` | Câ†’C | WebRTC Answer |
| `student:screen-ice` | Câ†’C | ICE Candidate |
| `student:location-update` | Câ†’S | í•™ìƒ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ |

### CCTV

| ì´ë²¤íŠ¸ | ë°©í–¥ | ì„¤ëª… |
|--------|------|------|
| `cctv:enable` | Câ†’S | CCTV í™œì„±í™” |
| `cctv:disable` | Câ†’S | CCTV ë¹„í™œì„±í™” |
| `cctv:viewer-joined` | Sâ†’C | ì‹œì²­ì ì…ì¥ |

---

## 21. í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹…

### URL íŒŒë¼ë¯¸í„° í…ŒìŠ¤íŠ¸

```bash
# ê°•ì‚¬ í…ŒìŠ¤íŠ¸ (ê°œë°œ í™˜ê²½ì—ì„œë§Œ ë™ì‘)
http://localhost:5173/metaverse?role=instructor

# í•™ìƒ í…ŒìŠ¤íŠ¸
http://localhost:5173/metaverse?role=student

# í•™ë¶€ëª¨ ì°¸ê´€ ëª¨ë“œ
http://localhost:5173/metaverse?mode=observer&studentId=xxx
```

### Debug Info UI

ë©”íƒ€ë²„ìŠ¤ í™”ë©´ì—ì„œ "Debug ì¼œê¸°" ë²„íŠ¼ìœ¼ë¡œ ë‹¤ìŒ ì •ë³´ í™•ì¸:
- í”Œë ˆì´ì–´ ìœ„ì¹˜ (X, Y, Z)
- í˜„ì¬ ë§µ
- ì•‰ê¸° ìƒíƒœ
- í™”ë©´ ê³µìœ  ìƒíƒœ
- ë§ˆì´í¬ ìƒíƒœ
- ë°© ì‚¬ìš©ì ëª©ë¡

### ì½˜ì†” ë¡œê·¸ í”„ë¦¬í”½ìŠ¤

| í”„ë¦¬í”½ìŠ¤ | ì˜ì—­ |
|---------|------|
| ğŸ¤ | ìŒì„± ì±„íŒ… |
| ğŸ“º | í™”ë©´ ê³µìœ  |
| ğŸ’¬ | í…ìŠ¤íŠ¸ ì±„íŒ… |
| ğŸ¨ | íŒì„œ |
| ğŸ–¥ï¸ | í•™ìƒ í™”ë©´ |
| ğŸ‘¥ | ë©€í‹°í”Œë ˆì´ì–´ |
| ğŸ”Œ | ì†Œì¼“ ì—°ê²° |
| ğŸ“ | ìœ„ì¹˜/ë§µ |
| ğŸšª | ë¬¸/í¬íƒˆ |
| ğŸ’º | ì•‰ê¸°/ì„œê¸° |

---

## 22. ì´ì‹ ì‹œ ì£¼ì˜ì‚¬í•­

### í•„ìˆ˜ ì˜ì¡´ì„±

**í”„ë¡ íŠ¸ì—”ë“œ:**
```json
{
  "dependencies": {
    "react": "^19.x",
    "three": "^0.x",
    "@react-three/fiber": "^8.x",
    "@react-three/drei": "^9.x",
    "@react-three/rapier": "^1.x",
    "three-stdlib": "^2.x",
    "socket.io-client": "^4.x",
    "zustand": "^4.x"
  }
}
```

**ë°±ì—”ë“œ:**
```json
{
  "dependencies": {
    "express": "^5.x",
    "socket.io": "^4.x",
    "@supabase/supabase-js": "^2.x"
  }
}
```

### ëª¨ë¸ íŒŒì¼ ê²½ë¡œ

```
public/
â””â”€â”€ models/
    â””â”€â”€ BaseCharacter.gltf  # ìºë¦­í„° ëª¨ë¸ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
```

### ì• ë‹ˆë©”ì´ì…˜ ì´ë¦„ ê·œì¹™

GLTF ëª¨ë¸ì— ë‹¤ìŒ ì´ë¦„ì˜ ì• ë‹ˆë©”ì´ì…˜ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
- `Idle` - ëŒ€ê¸°
- `Walk` ë˜ëŠ” `Walking` - ê±·ê¸°
- `Run` - ë‹¬ë¦¬ê¸° (ì„ íƒ)
- `SitDown` - ì•‰ê¸° (ì„ íƒ)

### ë¬¼ë¦¬ ì„¤ì • ì£¼ì˜ì‚¬í•­

```javascript
// Physics gravity ì„¤ì •
<Physics gravity={[0, -20, 0]}>

// ë§µ ë¡œë”© ì „ ë¬¼ë¦¬ ì¼ì‹œì •ì§€
<Physics paused={!isMapLoaded}>
```

### í¬ì¸í„° ë½ ì£¼ì˜ì‚¬í•­

- ìº”ë²„ìŠ¤ í´ë¦­ ì‹œì—ë§Œ í¬ì¸í„° ë½ ìš”ì²­ ê°€ëŠ¥
- ì‚¬ìš©ì ì œìŠ¤ì²˜ ì—†ì´ëŠ” ìë™ ë½ ë¶ˆê°€
- ESC í‚¤ë¡œ í•´ì œë¨ (ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘)
- ë©”ë‰´ ì—´ ë•Œë„ í•´ì œ í•„ìš”

### ì†Œì¼“ ì—°ê²° ì£¼ì˜ì‚¬í•­

```javascript
// ì—°ê²° ëŒ€ê¸° í›„ emit
await socketService.waitForConnection()
socketService.emit('event', data)

// ì—°ê²° ìƒíƒœ í™•ì¸
const socket = socketService.getSocket()
if (socket?.connected) { ... }
```

### WebRTC ì£¼ì˜ì‚¬í•­

- HTTPS í•„ìˆ˜ (localhost ì œì™¸)
- ë§ˆì´í¬/ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ í•„ìš”
- TURN ì„œë²„ ì—†ìœ¼ë©´ ì¼ë¶€ í™˜ê²½ì—ì„œ ì—°ê²° ì‹¤íŒ¨
- ICE Candidate êµí™˜ ì™„ë£Œ í›„ì—ë§Œ ìŠ¤íŠ¸ë¦¼ ì „ì†¡ ê°€ëŠ¥

---

## ë¶€ë¡: í”„ë¡œì íŠ¸ êµ¬ì¡° ìš”ì•½

```
src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ metaverse/
â”‚       â”œâ”€â”€ MetaverseScene.jsx    # ë©”ì¸ ì”¬ (ëª¨ë“  ê²ƒì„ ì¡°í•©)
â”‚       â”œâ”€â”€ Player.jsx            # ë‚´ ìºë¦­í„°
â”‚       â”œâ”€â”€ OtherPlayer.jsx       # ë‹¤ë¥¸ í”Œë ˆì´ì–´
â”‚       â”œâ”€â”€ CharacterModel.jsx    # ìºë¦­í„° ëª¨ë¸/ì• ë‹ˆë©”ì´ì…˜
â”‚       â”œâ”€â”€ ThirdPersonCamera.jsx # ì¹´ë©”ë¼
â”‚       â”œâ”€â”€ MapModel.jsx          # ë§µ ë¡œë”©/ì½œë¼ì´ë”
â”‚       â”œâ”€â”€ Portal.jsx            # í¬íƒˆ
â”‚       â”œâ”€â”€ Door.jsx              # ë¬¸
â”‚       â”œâ”€â”€ InteractiveObject.jsx # ì˜ì/êµíƒ
â”‚       â”œâ”€â”€ Screen.jsx            # í™”ë©´ ê³µìœ  3D í™”ë©´
â”‚       â”œâ”€â”€ ScreenShareOverlay.jsx# í™”ë©´ ê³µìœ  ì˜¤ë²„ë ˆì´
â”‚       â”œâ”€â”€ DeskMonitor.jsx       # ì±…ìƒ ìœ„ ëª¨ë‹ˆí„°
â”‚       â”œâ”€â”€ Blackboard.jsx        # ì¹ íŒ
â”‚       â”œâ”€â”€ ChatBox.jsx           # ì±„íŒ… UI
â”‚       â”œâ”€â”€ MetaverseUI.jsx       # ë©”ë‰´ UI
â”‚       â”œâ”€â”€ CCTVCamera.jsx        # CCTV
â”‚       â””â”€â”€ useKeyboardControls.js# í‚¤ë³´ë“œ ì…ë ¥
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useScreenShare.js         # ê°•ì‚¬ í™”ë©´ ê³µìœ 
â”‚   â”œâ”€â”€ useScreenReceive.js       # í•™ìƒ í™”ë©´ ìˆ˜ì‹ 
â”‚   â”œâ”€â”€ useStudentScreen.js       # í•™ìƒ í™”ë©´ ìº¡ì²˜
â”‚   â”œâ”€â”€ useVoiceChat.js           # ìŒì„± ì±„íŒ…
â”‚   â””â”€â”€ useChat.js                # í…ìŠ¤íŠ¸ ì±„íŒ…
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ socket.js                 # Socket.IO í´ë¼ì´ì–¸íŠ¸
â”‚   â””â”€â”€ api.js                    # REST API í´ë¼ì´ì–¸íŠ¸
â”‚
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ webrtc.js                 # WebRTC ì„¤ì •
â”‚
â””â”€â”€ stores/
    â””â”€â”€ authStore.js              # ì¸ì¦ ìƒíƒœ (Zustand)

server/
â”œâ”€â”€ sockets/
â”‚   â””â”€â”€ index.js                  # ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
â””â”€â”€ routes/
    â””â”€â”€ classrooms.js             # êµì‹¤ API (ì ‘ê·¼ ê¶Œí•œ ë“±)
```
